<!DOCTYPE html>
<html>
<head>
<title>GeoS4 - Sequencer V1</title>
<style>
    body { 
        font-family: sans-serif; 
        background-color: #0E1117; 
        color: white; 
        margin: 0; 
        padding: 0; 
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
    }
    .container {
        width: 100%;
        max-width: 800px;
        padding: 20px;
    }
    #sequencer-grid {
        display: grid;
        grid-template-columns: 80px repeat(16, 1fr);
        gap: 5px;
        padding: 10px;
        background-color: #1E1E1E;
        border-radius: 8px;
    }
    .cell, .header-cell, .track-label {
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
    }
    .header-cell, .track-label { 
        font-weight: bold;
        font-size: 0.9em;
    }
    .track-label { 
        background-color: #262730; 
    }
    .cell { 
        background-color: #444; 
        aspect-ratio: 1 / 1; 
        transition: all 0.1s ease;
    }
    .cell.active { 
        background-color: #1c64f2; 
    }
    .cell.playing, .header-cell.playing { 
        outline: 2px solid #FF4B4B; 
        outline-offset: 2px;
    }
    #audio-prompt {
        position: absolute; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%;
        background-color: rgba(0,0,0,0.8);
        display: flex; 
        align-items: center; 
        justify-content: center;
        font-size: 1.5em; 
        cursor: pointer; 
        z-index: 10;
    }
</style>
</head>
<body>

<div id="audio-prompt">Click to Start Audio</div>

<div class="container">
    <div id="sequencer-grid"></div>
</div>

<script>
    // --- Default Data (Normally Injected by Python) ---
    // You can modify this data to change the default pattern.
    const IS_PLAYING = true;
    const BPM = 120;
    const SEQUENCER_GRID = [
        [true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false], // Kick
        [false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false], // Snare
        [true, false, true, false, true, false, true, false, true, false, true, false, true, false, true, false], // Hi-Hat
        [false, false, true, false, false, false, false, true, false, false, false, false, true, false, false, false]  // Synth
    ];
    // --- End of Default Data ---

    const instrumentNames = ['Kick', 'Snare', 'Hi-Hat', 'Synth'];
    
    let audioContext;
    let currentBeat = 0;
    let futureTickTime;
    let timerID;

    const sequencerGridEl = document.getElementById('sequencer-grid');
    const audioPromptEl = document.getElementById('audio-prompt');

    // --- UI BUILDER ---
    function buildUI() {
        sequencerGridEl.innerHTML = '';
        // Header
        sequencerGridEl.appendChild(document.createElement('div'));
        for (let i = 0; i < 16; i++) {
            const headerCell = document.createElement('div');
            headerCell.className = 'header-cell';
            headerCell.id = `header-${i}`;
            headerCell.textContent = i + 1;
            sequencerGridEl.appendChild(headerCell);
        }
        // Tracks
        for (let i = 0; i < 4; i++) {
            const trackLabel = document.createElement('div');
            trackLabel.className = 'track-label';
            trackLabel.textContent = instrumentNames[i];
            sequencerGridEl.appendChild(trackLabel);
            for (let j = 0; j < 16; j++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.id = `cell-${i}-${j}`;
                if (SEQUENCER_GRID[i][j]) cell.classList.add('active');
                sequencerGridEl.appendChild(cell);
            }
        }
    }

    // --- WEB AUDIO SYNTHESIS ---
    function initAudio() {
        if (audioContext) return;
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        futureTickTime = audioContext.currentTime;
        audioPromptEl.style.display = 'none';
        if(IS_PLAYING) {
            play();
        }
    }
    
    const soundBank = [
        () => { // Kick
            const time = audioContext.currentTime;
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain); gain.connect(audioContext.destination);
            osc.frequency.setValueAtTime(150, time);
            gain.gain.setValueAtTime(1, time);
            osc.frequency.exponentialRampToValueAtTime(0.01, time + 0.1);
            gain.gain.exponentialRampToValueAtTime(0.01, time + 0.1);
            osc.start(time); osc.stop(time + 0.12);
        },
        () => { // Snare
            const time = audioContext.currentTime;
            const noise = audioContext.createBufferSource();
            const buffer = audioContext.createBuffer(1, audioContext.sampleRate, audioContext.sampleRate);
            const output = buffer.getChannelData(0);
            for (let i = 0; i < audioContext.sampleRate; i++) output[i] = Math.random() * 2 - 1;
            noise.buffer = buffer;
            const filter = audioContext.createBiquadFilter();
            filter.type = 'highpass'; filter.frequency.value = 1000;
            noise.connect(filter);
            const envelope = audioContext.createGain();
            filter.connect(envelope); envelope.connect(audioContext.destination);
            envelope.gain.setValueAtTime(1, time);
            envelope.gain.exponentialRampToValueAtTime(0.01, time + 0.2);
            noise.start(time); noise.stop(time + 0.2);
        },
        () => { // Hi-Hat
            const time = audioContext.currentTime;
            const gain = audioContext.createGain();
            const fundamental = 40, ratios = [2, 3, 4.16, 5.43, 6.79, 8.21];
            ratios.forEach(r => {
                const osc = audioContext.createOscillator();
                osc.type = 'square'; osc.frequency.value = fundamental * r;
                osc.connect(gain); osc.start(time); osc.stop(time + 0.05);
            });
            const filter = audioContext.createBiquadFilter();
            filter.type = 'highpass'; filter.frequency.value = 7000;
            gain.connect(filter);
            const envelope = audioContext.createGain();
            filter.connect(envelope); envelope.connect(audioContext.destination);
            envelope.gain.setValueAtTime(1, time);
            envelope.gain.exponentialRampToValueAtTime(0.01, time + 0.05);
        },
        () => { // Synth
            const time = audioContext.currentTime;
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain); gain.connect(audioContext.destination);
            osc.type = 'triangle'; osc.frequency.setValueAtTime(440, time);
            gain.gain.setValueAtTime(0.5, time);
            gain.gain.exponentialRampToValueAtTime(0.01, time + 0.15);
            osc.start(time); osc.stop(time + 0.2);
        }
    ];

    // --- SEQUENCER LOGIC ---
    function updateUI(beat) {
        // Clear previous beat highlight
        const prevBeat = (beat - 1 + 16) % 16;
        document.getElementById(`header-${prevBeat}`).classList.remove('playing');
        for(let i=0; i<4; i++) document.getElementById(`cell-${i}-${prevBeat}`).classList.remove('playing');
        
        // Set current beat highlight
        document.getElementById(`header-${beat}`).classList.add('playing');
        for(let i=0; i<4; i++) document.getElementById(`cell-${i}-${beat}`).classList.add('playing');
    }

    function scheduler() {
        while (futureTickTime < audioContext.currentTime + 0.1) {
            // Play sounds
            for (let i = 0; i < 4; i++) {
                if (SEQUENCER_GRID[i][currentBeat]) soundBank[i]();
            }
            
            // Update UI in time with audio
            const beatToUpdate = currentBeat;
            setTimeout(() => updateUI(beatToUpdate), (futureTickTime - audioContext.currentTime) * 1000);

            // Advance beat
            const secondsPerBeat = 60.0 / BPM / 4.0; // 16th notes
            futureTickTime += secondsPerBeat;
            currentBeat = (currentBeat + 1) % 16;
        }
        timerID = window.setTimeout(scheduler, 25.0);
    }
    
    function play() {
        currentBeat = 0;
        futureTickTime = audioContext.currentTime;
        scheduler();
    }

    // --- ENTRY POINT ---
    document.body.addEventListener('click', initAudio, { once: true });
    buildUI();

</script>
</body>
</html>
